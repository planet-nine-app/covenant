<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Covenant Extension Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #64b5f6, #81c784);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            font-size: 16px;
            color: #b0bec5;
        }

        .extension-status {
            background: rgba(100, 181, 246, 0.1);
            border: 1px solid #64b5f6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .extension-status.active {
            background: rgba(129, 199, 132, 0.1);
            border-color: #81c784;
        }

        .extension-status.inactive {
            background: rgba(244, 67, 54, 0.1);
            border-color: #f44336;
        }

        .contract-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #64b5f6;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .contract-title {
            font-size: 24px;
            font-weight: bold;
            color: #64b5f6;
            margin-bottom: 10px;
        }

        .contract-meta {
            font-size: 14px;
            color: #b0bec5;
            margin-bottom: 20px;
        }

        .step {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(129, 199, 132, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .step-title {
            font-size: 16px;
            font-weight: bold;
            color: #ffffff;
        }

        .step-status {
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(176, 190, 197, 0.2);
            color: #b0bec5;
        }

        .covenant-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(45deg, #64b5f6, #667eea);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .covenant-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(100, 181, 246, 0.3);
        }

        .success-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #81c784, #4caf50);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .debug-output {
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .debug-line {
            margin: 2px 0;
        }

        .debug-line.error {
            color: #ff6b6b;
        }

        .debug-line.success {
            color: #51cf66;
        }

        .debug-line.info {
            color: #74c0fc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìú Live Covenant Extension Test</h1>
            <p>Test covenant step signing with real contract data from the running service</p>
        </div>

        <div class="extension-status" id="extension-status">
            <h3>üîç Checking for The Advancement Extension...</h3>
            <p>Loading extension status...</p>
        </div>

        <div class="contract-card">
            <div class="contract-title">SVG Test Contract</div>
            <div class="contract-meta">
                Contract UUID: 144f602d-75ab-473c-9c55-b29bf2defee0 ‚Ä¢ 2 Participants ‚Ä¢ Running Service
            </div>

            <div class="step">
                <div class="step-header">
                    <div class="step-title">Step 1: Generate beautiful SVG representations</div>
                    <div class="step-status">‚è≥ Awaiting signatures (0/2)</div>
                </div>
                <button 
                    class="covenant-button" 
                    spell="covenant" 
                    spell-components='{"contractUuid":"144f602d-75ab-473c-9c55-b29bf2defee0","stepId":"132df700-fdbf-4ac9-85f5-649c0326e550","action":"signStep"}'>
                    <span>‚úçÔ∏è</span> Sign Step 1 with Extension
                </button>
            </div>

            <div class="step">
                <div class="step-header">
                    <div class="step-title">Step 2: Store in BDO for cross-service access</div>
                    <div class="step-status">‚è≥ Awaiting signatures (0/2)</div>
                </div>
                <button 
                    class="covenant-button" 
                    spell="covenant" 
                    spell-components='{"contractUuid":"144f602d-75ab-473c-9c55-b29bf2defee0","stepId":"7fc354f2-96a2-4751-b941-1f9cb5143c1c","action":"signStep"}'>
                    <span>‚úçÔ∏è</span> Sign Step 2 with Extension
                </button>
            </div>
        </div>

        <div class="debug-output" id="debug-output">
            <div class="debug-line info">üîß Debug Output</div>
        </div>
    </div>

    <script>
        let debugOutput = document.getElementById('debug-output');
        
        function addDebugLine(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `debug-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugOutput.appendChild(line);
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }

        // Check for The Advancement extension
        function checkExtensionStatus() {
            const statusEl = document.getElementById('extension-status');
            
            if (typeof window.AdvancementExtension !== 'undefined') {
                statusEl.className = 'extension-status active';
                statusEl.innerHTML = `
                    <h3>‚úÖ The Advancement Extension Active</h3>
                    <p>Version: ${window.AdvancementExtension.version} ‚Ä¢ Ready for covenant signing</p>
                `;
                addDebugLine('‚úÖ The Advancement extension detected', 'success');
            } else if (typeof window.castSpell === 'function') {
                statusEl.className = 'extension-status active';
                statusEl.innerHTML = `
                    <h3>‚úÖ Spell Casting Available</h3>
                    <p>Covenant spell system ready</p>
                `;
                addDebugLine('‚úÖ Spell casting function detected', 'success');
            } else {
                statusEl.className = 'extension-status inactive';
                statusEl.innerHTML = `
                    <h3>‚ùå The Advancement Extension Not Detected</h3>
                    <p>Please install and enable The Advancement extension to sign contract steps</p>
                `;
                addDebugLine('‚ùå The Advancement extension not found', 'error');
            }
        }

        // Listen for covenant step signing events
        document.addEventListener('covenantStepSigned', (event) => {
            addDebugLine(`üìú Covenant step signed: ${JSON.stringify(event.detail)}`, 'success');
            
            const { contractUuid, stepId, stepCompleted, userUUID } = event.detail;
            
            // Update UI to show step was signed
            const contractElements = document.querySelectorAll(`[spell-components*="${contractUuid}"][spell-components*="${stepId}"]`);
            contractElements.forEach(element => {
                const stepDiv = element.closest('.step');
                if (stepDiv) {
                    const statusEl = stepDiv.querySelector('.step-status');
                    const buttonEl = stepDiv.querySelector('.covenant-button');
                    
                    if (stepCompleted) {
                        statusEl.textContent = '‚úÖ Step Completed (2/2)';
                        statusEl.style.background = 'rgba(129, 199, 132, 0.2)';
                        statusEl.style.color = '#81c784';
                        buttonEl.innerHTML = '<span>üîÑ</span> Re-sign Step';
                        addDebugLine(`‚úÖ Step completed: ${stepId}`, 'success');
                    } else {
                        statusEl.textContent = '‚úçÔ∏è You signed (1/2)';
                        statusEl.style.background = 'rgba(255, 183, 77, 0.2)';
                        statusEl.style.color = '#ffb74d';
                        buttonEl.innerHTML = '<span>üîÑ</span> Re-sign Step';
                        addDebugLine(`‚úçÔ∏è Step signed, awaiting others: ${stepId}`, 'info');
                    }
                }
            });
            
            // Show success notification
            showSuccessNotification(stepCompleted ? 'Step Completed!' : 'Step Signed!', contractUuid, stepId);
        });

        function showSuccessNotification(title, contractUuid, stepId) {
            const notification = document.createElement('div');
            notification.className = 'success-notification';
            notification.innerHTML = `üìú ${title}<br><small>Contract: ${contractUuid.substring(0, 8)}... Step: ${stepId}</small>`;
            
            document.body.appendChild(notification);
            
            // Remove notification after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 4000);
        }

        // Manual spell casting fallback for testing
        if (typeof window.castSpell === 'undefined') {
            window.castSpell = function(element) {
                addDebugLine('üß™ Manual spell casting (extension fallback)', 'info');
                const spell = element.getAttribute('spell');
                const components = element.getAttribute('spell-components');
                
                addDebugLine(`Spell: ${spell}, Components: ${components}`, 'info');
                
                if (spell === 'covenant') {
                    const data = JSON.parse(components);
                    alert(`üß™ Test Covenant Signing\n\nContract: ${data.contractUuid}\nStep: ${data.stepId}\n\n(This would normally go through The Advancement extension)`);
                    addDebugLine(`üß™ Simulated signing: ${data.stepId}`, 'info');
                }
            };
        }

        // Initialize
        addDebugLine('üìú Live covenant extension test page loaded', 'info');
        addDebugLine('üîß Covenant service should be running on http://localhost:3011', 'info');
        addDebugLine('üìã Real contract UUID: 144f602d-75ab-473c-9c55-b29bf2defee0', 'info');
        addDebugLine('üìã Step 1 ID: 132df700-fdbf-4ac9-85f5-649c0326e550', 'info');
        addDebugLine('üìã Step 2 ID: 7fc354f2-96a2-4751-b941-1f9cb5143c1c', 'info');
        
        // Wait for potential extension loading
        setTimeout(checkExtensionStatus, 1000);
        
        // Check periodically in case extension loads later
        setInterval(checkExtensionStatus, 5000);
    </script>
</body>
</html>